// Prisma Schema for CRM System
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 系统用户和认证
// ============================================

model User {
  id            String    @id @default(uuid())
  username      String    @unique @db.VarChar(50)
  passwordHash  String    @map("password_hash") @db.VarChar(255)
  name          String    @db.VarChar(50)
  role          UserRole
  staffId       String?   @map("staff_id")
  staff         Staff?    @relation(fields: [staffId], references: [id])
  status        UserStatus
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // 操作记录
  rechargeRecords  RechargeRecord[]
  consumeRecords   ConsumeRecord[]
  stockLogs        StockLog[]

  @@map("users")
}

enum UserRole {
  admin
  staff
}

enum UserStatus {
  active
  inactive
}

// ============================================
// 员工表
// ============================================

model Staff {
  id        String      @id @default(uuid())
  name      String      @db.VarChar(50)
  phone     String?     @db.VarChar(20)
  role      StaffRole
  status    StaffStatus
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  users        User[]
  appointments Appointment[]

  @@map("staff")
}

enum StaffRole {
  technician
  cashier
  manager
}

enum StaffStatus {
  active
  inactive
}

// ============================================
// 会员管理
// ============================================

model Member {
  id             String       @id @default(uuid())
  memberNo       String       @unique @map("member_no") @db.VarChar(20)
  name           String       @db.VarChar(50)
  phone          String       @unique @db.VarChar(20)
  gender         Gender?
  birthday       DateTime?    @db.Date
  levelId        String       @map("level_id")
  level          MemberLevel  @relation(fields: [levelId], references: [id])
  balance        Decimal      @default(0) @db.Decimal(10, 2)
  giftBalance    Decimal      @default(0) @map("gift_balance") @db.Decimal(10, 2)
  points         Int          @default(0)
  totalRecharge  Decimal      @default(0) @map("total_recharge") @db.Decimal(10, 2)
  totalConsume   Decimal      @default(0) @map("total_consume") @db.Decimal(10, 2)
  remark         String?      @db.Text
  status         MemberStatus
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  rechargeRecords RechargeRecord[]
  consumeRecords  ConsumeRecord[]
  appointments    Appointment[]

  @@map("members")
}

enum Gender {
  male
  female
  unknown
}

enum MemberStatus {
  active
  frozen
  deleted
}

model MemberLevel {
  id             String   @id @default(uuid())
  name           String   @db.VarChar(50)
  levelOrder     Int      @map("level_order")
  upgradeAmount  Decimal  @map("upgrade_amount") @db.Decimal(10, 2)
  discount       Decimal  @db.Decimal(3, 2)
  pointsRate     Decimal  @map("points_rate") @db.Decimal(3, 2)
  description    String?  @db.Text
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  members Member[]

  @@map("member_levels")
}

// ============================================
// 充值系统
// ============================================

model RechargeRecord {
  id            String         @id @default(uuid())
  memberId      String         @map("member_id")
  member        Member         @relation(fields: [memberId], references: [id])
  amount        Decimal        @db.Decimal(10, 2)
  giftAmount    Decimal        @default(0) @map("gift_amount") @db.Decimal(10, 2)
  paymentMethod PaymentMethod  @map("payment_method")
  packageId     String?        @map("package_id")
  package       RechargePackage? @relation(fields: [packageId], references: [id])
  operatorId    String         @map("operator_id")
  operator      User           @relation(fields: [operatorId], references: [id])
  status        RecordStatus
  remark        String?        @db.Text
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  @@map("recharge_records")
}

model RechargePackage {
  id          String   @id @default(uuid())
  name        String   @db.VarChar(100)
  amount      Decimal  @db.Decimal(10, 2)
  giftAmount  Decimal  @map("gift_amount") @db.Decimal(10, 2)
  isActive    Boolean  @default(true) @map("is_active")
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  rechargeRecords RechargeRecord[]

  @@map("recharge_packages")
}

enum PaymentMethod {
  cash
  wechat
  alipay
  bank_card
}

enum RecordStatus {
  success
  cancelled
}

// ============================================
// 消费系统
// ============================================

model ConsumeRecord {
  id             String        @id @default(uuid())
  memberId       String        @map("member_id")
  member         Member        @relation(fields: [memberId], references: [id])
  totalAmount    Decimal       @map("total_amount") @db.Decimal(10, 2)
  discountAmount Decimal       @default(0) @map("discount_amount") @db.Decimal(10, 2)
  actualAmount   Decimal       @map("actual_amount") @db.Decimal(10, 2)
  balancePaid    Decimal       @default(0) @map("balance_paid") @db.Decimal(10, 2)
  cashPaid       Decimal       @default(0) @map("cash_paid") @db.Decimal(10, 2)
  pointsEarned   Int           @default(0) @map("points_earned")
  pointsUsed     Int           @default(0) @map("points_used")
  operatorId     String        @map("operator_id")
  operator       User          @relation(fields: [operatorId], references: [id])
  status         RecordStatus
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  items ConsumeItem[]

  @@map("consume_records")
}

model ConsumeItem {
  id         String        @id @default(uuid())
  consumeId  String        @map("consume_id")
  consume    ConsumeRecord @relation(fields: [consumeId], references: [id], onDelete: Cascade)
  itemType   ItemType      @map("item_type")
  itemId     String        @map("item_id")
  itemName   String        @map("item_name") @db.VarChar(100)
  quantity   Int
  unitPrice  Decimal       @map("unit_price") @db.Decimal(10, 2)
  subtotal   Decimal       @db.Decimal(10, 2)

  @@map("consume_items")
}

enum ItemType {
  product
  service
}

// ============================================
// 产品库存
// ============================================

model ProductCategory {
  id        String    @id @default(uuid())
  name      String    @db.VarChar(100)
  parentId  String?   @map("parent_id")
  parent    ProductCategory? @relation("CategoryTree", fields: [parentId], references: [id])
  children  ProductCategory[] @relation("CategoryTree")
  sortOrder Int       @default(0) @map("sort_order")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  products Product[]

  @@map("product_categories")
}

model Product {
  id         String          @id @default(uuid())
  name       String          @db.VarChar(100)
  categoryId String          @map("category_id")
  category   ProductCategory @relation(fields: [categoryId], references: [id])
  sku        String?         @db.VarChar(50)
  barcode    String?         @db.VarChar(50)
  price      Decimal         @db.Decimal(10, 2)
  cost       Decimal?        @db.Decimal(10, 2)
  stock      Int             @default(0)
  minStock   Int?            @map("min_stock")
  unit       String          @db.VarChar(20)
  imageUrl   String?         @map("image_url") @db.VarChar(255)
  status     ProductStatus
  createdAt  DateTime        @default(now()) @map("created_at")
  updatedAt  DateTime        @updatedAt @map("updated_at")

  stockLogs StockLog[]

  @@map("products")
}

enum ProductStatus {
  on_sale
  off_sale
}

model StockLog {
  id          String        @id @default(uuid())
  productId   String        @map("product_id")
  product     Product       @relation(fields: [productId], references: [id])
  type        StockLogType
  quantity    Int
  beforeStock Int           @map("before_stock")
  afterStock  Int           @map("after_stock")
  reason      String?       @db.VarChar(100)
  relatedId   String?       @map("related_id")
  operatorId  String        @map("operator_id")
  operator    User          @relation(fields: [operatorId], references: [id])
  createdAt   DateTime      @default(now()) @map("created_at")

  @@map("stock_logs")
}

enum StockLogType {
  in
  out
  adjust
  check
}

// ============================================
// 服务项目
// ============================================

model Service {
  id          String        @id @default(uuid())
  name        String        @db.VarChar(100)
  categoryId  String?       @map("category_id")
  price       Decimal       @db.Decimal(10, 2)
  duration    Int
  description String?       @db.Text
  status      ServiceStatus
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  appointments Appointment[]

  @@map("services")
}

enum ServiceStatus {
  active
  inactive
}

// ============================================
// 预约系统
// ============================================

model Appointment {
  id              String            @id @default(uuid())
  memberId        String            @map("member_id")
  member          Member            @relation(fields: [memberId], references: [id])
  serviceId       String            @map("service_id")
  service         Service           @relation(fields: [serviceId], references: [id])
  staffId         String?           @map("staff_id")
  staff           Staff?            @relation(fields: [staffId], references: [id])
  appointmentDate DateTime          @map("appointment_date") @db.Date
  startTime       DateTime          @map("start_time") @db.Time
  endTime         DateTime          @map("end_time") @db.Time
  status          AppointmentStatus
  remark          String?           @db.Text
  cancelReason    String?           @map("cancel_reason") @db.VarChar(200)
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  @@map("appointments")
}

enum AppointmentStatus {
  pending
  confirmed
  completed
  cancelled
  no_show
}
